import { isDesktopChrome } from '@terra-dev/browser-check';
import { AccAddress } from '@terra-money/terra.js';
import { BehaviorSubject } from 'rxjs';
import { defaultSelectModal } from './defaultSelectModal';
import { extensionFixer } from './extensionFixer';
import { getTerraChromeExtensions } from './multiChannel';
import { clearSession, getStoredSession, storeSession } from './storage';
import { ChromeExtensionStatus } from './types';
export class ChromeExtensionController {
    constructor(options) {
        this.options = options;
        this._extension = null;
        this.status = () => {
            return this._status.asObservable();
        };
        this.networkInfo = () => {
            return this._networkInfo.asObservable();
        };
        this.terraAddress = () => {
            return this._terraAddress.asObservable();
        };
        this.checkStatus = async () => {
            // do not check if browser isn't a chrome
            if (!this.isDesktopChrome) {
                return;
            }
            if (this.extensionInfos.length === 0) {
                this._status.next(ChromeExtensionStatus.UNAVAILABLE);
                return;
            }
            if (!this._extension) {
                this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                return;
            }
            // get networkInfo from extension
            const infoPayload = await this._extension.info();
            if (infoPayload &&
                this._networkInfo.getValue().chainID !== infoPayload.chainID) {
                this._networkInfo.next(infoPayload);
            }
            if (this.options.enableWalletConnection) {
                //const storageStoredWalletAddress: string | null = getStoredAddress();
                const session = getStoredSession();
                // if the storage has wallet address
                if (session && AccAddress.validate(session.walletAddress)) {
                    this._status.next(ChromeExtensionStatus.WALLET_CONNECTED);
                    const connectResult = await this._extension.connect();
                    // if address of extension is not same with the address of localStorage
                    if (connectResult.address &&
                        AccAddress.validate(connectResult.address)) {
                        storeSession({
                            walletAddress: connectResult.address,
                            identifier: session.identifier,
                        });
                    }
                    if (!!connectResult.address) {
                        if (this._terraAddress.getValue() !== connectResult.address) {
                            this._terraAddress.next(connectResult.address);
                        }
                    }
                    else {
                        clearSession();
                        this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    }
                }
                else {
                    if (session) {
                        clearSession();
                    }
                    this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    this._terraAddress.next(null);
                }
            }
            else {
                this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                this._terraAddress.next(null);
            }
        };
        this.connect = async (identifier) => {
            var _a;
            const extensionInfos = getTerraChromeExtensions();
            if (extensionInfos.length === 0) {
                return false;
            }
            let extensionInfo;
            if (identifier) {
                extensionInfo = extensionInfos.find((item) => item.identifier === identifier);
            }
            else if (extensionInfos.length === 1) {
                extensionInfo = extensionInfos[0];
            }
            else {
                const select = (_a = this.options.selectExtension) !== null && _a !== void 0 ? _a : defaultSelectModal;
                const selection = await select(extensionInfos);
                if (selection) {
                    extensionInfo = selection;
                }
            }
            if (extensionInfo) {
                this._extension = extensionFixer(extensionInfo.identifier);
                const result = await this._extension.connect();
                if (result === null || result === void 0 ? void 0 : result.address) {
                    const walletAddress = result.address;
                    storeSession({
                        identifier: extensionInfo.identifier,
                        walletAddress,
                    });
                    await this.checkStatus();
                    return true;
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        };
        this.disconnect = () => {
            clearSession();
            this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
            this._terraAddress.next(null);
            this._extension = null;
        };
        this.recheckStatus = () => {
            if (this._extension && !this._extension.inTransactionProgress()) {
                this.checkStatus();
            }
        };
        this.post = (data) => {
            if (!this._extension) {
                throw new Error(`There is no connected wallet`);
            }
            return this._extension.post(data);
        };
        this.sign = (data) => {
            if (!this._extension) {
                throw new Error(`There is no connected wallet`);
            }
            return this._extension.sign(data);
        };
        this.isDesktopChrome =
            typeof window !== 'undefined' &&
                isDesktopChrome(options.dangerously__chromeExtensionCompatibleBrowserCheck(navigator.userAgent));
        this._status = new BehaviorSubject(this.isDesktopChrome
            ? ChromeExtensionStatus.INITIALIZING
            : ChromeExtensionStatus.UNAVAILABLE);
        this._networkInfo = new BehaviorSubject(options.defaultNetwork);
        this.extensionInfos = getTerraChromeExtensions();
        if (!this.isDesktopChrome) {
            this._terraAddress = new BehaviorSubject(null);
            return;
        }
        // ---------------------------------------------
        // initialize session
        // ---------------------------------------------
        if (this.extensionInfos.length === 0) {
            this._terraAddress = new BehaviorSubject(null);
            this._status.next(ChromeExtensionStatus.UNAVAILABLE);
            return;
        }
        const session = getStoredSession();
        if (!session ||
            !this.extensionInfos.some((item) => item.identifier === session.identifier)) {
            this._terraAddress = new BehaviorSubject(null);
            this._status.next(ChromeExtensionStatus.WALLET_NOT_CONNECTED);
            return;
        }
        this._terraAddress = new BehaviorSubject(session.walletAddress);
        this._extension = extensionFixer(session.identifier);
        this.checkStatus();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9AdGVycmEtZGV2L2Nocm9tZS1leHRlbnNpb24vQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFM0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGNBQWMsRUFBa0IsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRSxPQUFPLEVBQXVCLHdCQUF3QixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBYWhELE1BQU0sT0FBTyx5QkFBeUI7SUFTcEMsWUFBcUIsT0FBeUM7UUFBekMsWUFBTyxHQUFQLE9BQU8sQ0FBa0M7UUFMdEQsZUFBVSxHQUEwQixJQUFJLENBQUM7UUE4RGpELFdBQU0sR0FBRyxHQUFHLEVBQUU7WUFDWixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDckMsQ0FBQyxDQUFDO1FBRUYsZ0JBQVcsR0FBRyxHQUFHLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzFDLENBQUMsQ0FBQztRQUVGLGlCQUFZLEdBQUcsR0FBRyxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzQyxDQUFDLENBQUM7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Q0FDdEMsT0FBTyxDQUFDLGFBQWEsQ0FDdEIsQ0FBQztRQUVGLElBQUksQ0FBQyxVQUFVLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVyRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckIsQ0FBQztDQWtLRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRGVza3RvcENocm9tZSB9IGZyb20gJ0B0ZXJyYS1kZXYvYnJvd3Nlci1jaGVjayc7XG5pbXBvcnQgeyBOZXR3b3JrSW5mbyB9IGZyb20gJ0B0ZXJyYS1kZXYvd2FsbGV0LXR5cGVzJztcbmltcG9ydCB7IEFjY0FkZHJlc3MgfSBmcm9tICdAdGVycmEtbW9uZXkvdGVycmEuanMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWZhdWx0U2VsZWN0TW9kYWwgfSBmcm9tICcuL2RlZmF1bHRTZWxlY3RNb2RhbCc7XG5pbXBvcnQgeyBleHRlbnNpb25GaXhlciwgRml4ZWRFeHRlbnNpb24gfSBmcm9tICcuL2V4dGVuc2lvbkZpeGVyJztcbmltcG9ydCB7IENocm9tZUV4dGVuc2lvbkluZm8sIGdldFRlcnJhQ2hyb21lRXh0ZW5zaW9ucyB9IGZyb20gJy4vbXVsdGlDaGFubmVsJztcbmltcG9ydCB7IGNsZWFyU2Vzc2lvbiwgZ2V0U3RvcmVkU2Vzc2lvbiwgc3RvcmVTZXNzaW9uIH0gZnJvbSAnLi9zdG9yYWdlJztcbmltcG9ydCB7IENocm9tZUV4dGVuc2lvblN0YXR1cyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXJPcHRpb25zIHtcbiAgZGVmYXVsdE5ldHdvcms6IE5ldHdvcmtJbmZvO1xuICBlbmFibGVXYWxsZXRDb25uZWN0aW9uOiBib29sZWFuO1xuICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjazogKFxuICAgIHVzZXJBZ2VudDogc3RyaW5nLFxuICApID0+IGJvb2xlYW47XG4gIHNlbGVjdEV4dGVuc2lvbj86IChcbiAgICBleHRlbnNpb25JbmZvczogQ2hyb21lRXh0ZW5zaW9uSW5mb1tdLFxuICApID0+IFByb21pc2U8Q2hyb21lRXh0ZW5zaW9uSW5mbyB8IG51bGw+O1xufVxuXG5leHBvcnQgY2xhc3MgQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlciB7XG4gIHJlYWRvbmx5IF9zdGF0dXM6IEJlaGF2aW9yU3ViamVjdDxDaHJvbWVFeHRlbnNpb25TdGF0dXM+O1xuICByZWFkb25seSBfbmV0d29ya0luZm86IEJlaGF2aW9yU3ViamVjdDxOZXR3b3JrSW5mbz47XG4gIHJlYWRvbmx5IF90ZXJyYUFkZHJlc3M6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPjtcbiAgcHJpdmF0ZSBfZXh0ZW5zaW9uOiBGaXhlZEV4dGVuc2lvbiB8IG51bGwgPSBudWxsO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZXh0ZW5zaW9uSW5mb3M6IENocm9tZUV4dGVuc2lvbkluZm9bXTtcbiAgcHJpdmF0ZSByZWFkb25seSBpc0Rlc2t0b3BDaHJvbWU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgb3B0aW9uczogQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlck9wdGlvbnMpIHtcbiAgICB0aGlzLmlzRGVza3RvcENocm9tZSA9XG4gICAgICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgaXNEZXNrdG9wQ2hyb21lKFxuICAgICAgICBvcHRpb25zLmRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrKFxuICAgICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnQsXG4gICAgICAgICksXG4gICAgICApO1xuXG4gICAgdGhpcy5fc3RhdHVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDaHJvbWVFeHRlbnNpb25TdGF0dXM+KFxuICAgICAgdGhpcy5pc0Rlc2t0b3BDaHJvbWVcbiAgICAgICAgPyBDaHJvbWVFeHRlbnNpb25TdGF0dXMuSU5JVElBTElaSU5HXG4gICAgICAgIDogQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLlVOQVZBSUxBQkxFLFxuICAgICk7XG5cbiAgICB0aGlzLl9uZXR3b3JrSW5mbyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmV0d29ya0luZm8+KFxuICAgICAgb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICApO1xuXG4gICAgdGhpcy5leHRlbnNpb25JbmZvcyA9IGdldFRlcnJhQ2hyb21lRXh0ZW5zaW9ucygpO1xuXG4gICAgaWYgKCF0aGlzLmlzRGVza3RvcENocm9tZSkge1xuICAgICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBpbml0aWFsaXplIHNlc3Npb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBpZiAodGhpcy5leHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3RlcnJhQWRkcmVzcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4obnVsbCk7XG4gICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuVU5BVkFJTEFCTEUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb24gPSBnZXRTdG9yZWRTZXNzaW9uKCk7XG5cbiAgICBpZiAoXG4gICAgICAhc2Vzc2lvbiB8fFxuICAgICAgIXRoaXMuZXh0ZW5zaW9uSW5mb3Muc29tZShcbiAgICAgICAgKGl0ZW0pID0+IGl0ZW0uaWRlbnRpZmllciA9PT0gc2Vzc2lvbi5pZGVudGlmaWVyLFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihcbiAgICAgIHNlc3Npb24ud2FsbGV0QWRkcmVzcyxcbiAgICApO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uID0gZXh0ZW5zaW9uRml4ZXIoc2Vzc2lvbi5pZGVudGlmaWVyKTtcblxuICAgIHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgfVxuXG4gIHN0YXR1cyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdHVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIG5ldHdvcmtJbmZvID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9uZXR3b3JrSW5mby5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICB0ZXJyYUFkZHJlc3MgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3RlcnJhQWRkcmVzcy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBjaGVja1N0YXR1cyA9IGFzeW5jICgpID0+IHtcbiAgICAvLyBkbyBub3QgY2hlY2sgaWYgYnJvd3NlciBpc24ndCBhIGNocm9tZVxuICAgIGlmICghdGhpcy5pc0Rlc2t0b3BDaHJvbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5leHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5VTkFWQUlMQUJMRSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLl9leHRlbnNpb24pIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZ2V0IG5ldHdvcmtJbmZvIGZyb20gZXh0ZW5zaW9uXG4gICAgY29uc3QgaW5mb1BheWxvYWQgPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uaW5mbygpO1xuXG4gICAgaWYgKFxuICAgICAgaW5mb1BheWxvYWQgJiZcbiAgICAgIHRoaXMuX25ldHdvcmtJbmZvLmdldFZhbHVlKCkuY2hhaW5JRCAhPT0gaW5mb1BheWxvYWQuY2hhaW5JRFxuICAgICkge1xuICAgICAgdGhpcy5fbmV0d29ya0luZm8ubmV4dChpbmZvUGF5bG9hZCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5lbmFibGVXYWxsZXRDb25uZWN0aW9uKSB7XG4gICAgICAvL2NvbnN0IHN0b3JhZ2VTdG9yZWRXYWxsZXRBZGRyZXNzOiBzdHJpbmcgfCBudWxsID0gZ2V0U3RvcmVkQWRkcmVzcygpO1xuICAgICAgY29uc3Qgc2Vzc2lvbiA9IGdldFN0b3JlZFNlc3Npb24oKTtcblxuICAgICAgLy8gaWYgdGhlIHN0b3JhZ2UgaGFzIHdhbGxldCBhZGRyZXNzXG4gICAgICBpZiAoc2Vzc2lvbiAmJiBBY2NBZGRyZXNzLnZhbGlkYXRlKHNlc3Npb24ud2FsbGV0QWRkcmVzcykpIHtcbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9DT05ORUNURUQpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3RSZXN1bHQgPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uY29ubmVjdCgpO1xuXG4gICAgICAgIC8vIGlmIGFkZHJlc3Mgb2YgZXh0ZW5zaW9uIGlzIG5vdCBzYW1lIHdpdGggdGhlIGFkZHJlc3Mgb2YgbG9jYWxTdG9yYWdlXG4gICAgICAgIGlmIChcbiAgICAgICAgICBjb25uZWN0UmVzdWx0LmFkZHJlc3MgJiZcbiAgICAgICAgICBBY2NBZGRyZXNzLnZhbGlkYXRlKGNvbm5lY3RSZXN1bHQuYWRkcmVzcylcbiAgICAgICAgKSB7XG4gICAgICAgICAgc3RvcmVTZXNzaW9uKHtcbiAgICAgICAgICAgIHdhbGxldEFkZHJlc3M6IGNvbm5lY3RSZXN1bHQuYWRkcmVzcyxcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IHNlc3Npb24uaWRlbnRpZmllcixcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIWNvbm5lY3RSZXN1bHQuYWRkcmVzcykge1xuICAgICAgICAgIGlmICh0aGlzLl90ZXJyYUFkZHJlc3MuZ2V0VmFsdWUoKSAhPT0gY29ubmVjdFJlc3VsdC5hZGRyZXNzKSB7XG4gICAgICAgICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChjb25uZWN0UmVzdWx0LmFkZHJlc3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjbGVhclNlc3Npb24oKTtcbiAgICAgICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoc2Vzc2lvbikge1xuICAgICAgICAgIGNsZWFyU2Vzc2lvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVEKTtcbiAgICAgICAgdGhpcy5fdGVycmFBZGRyZXNzLm5leHQobnVsbCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChudWxsKTtcbiAgICB9XG4gIH07XG5cbiAgY29ubmVjdCA9IGFzeW5jIChpZGVudGlmaWVyPzogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZXh0ZW5zaW9uSW5mb3MgPSBnZXRUZXJyYUNocm9tZUV4dGVuc2lvbnMoKTtcblxuICAgIGlmIChleHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgZXh0ZW5zaW9uSW5mbzogQ2hyb21lRXh0ZW5zaW9uSW5mbyB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChpZGVudGlmaWVyKSB7XG4gICAgICBleHRlbnNpb25JbmZvID0gZXh0ZW5zaW9uSW5mb3MuZmluZChcbiAgICAgICAgKGl0ZW0pID0+IGl0ZW0uaWRlbnRpZmllciA9PT0gaWRlbnRpZmllcixcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDEpIHtcbiAgICAgIGV4dGVuc2lvbkluZm8gPSBleHRlbnNpb25JbmZvc1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc2VsZWN0ID0gdGhpcy5vcHRpb25zLnNlbGVjdEV4dGVuc2lvbiA/PyBkZWZhdWx0U2VsZWN0TW9kYWw7XG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSBhd2FpdCBzZWxlY3QoZXh0ZW5zaW9uSW5mb3MpO1xuXG4gICAgICBpZiAoc2VsZWN0aW9uKSB7XG4gICAgICAgIGV4dGVuc2lvbkluZm8gPSBzZWxlY3Rpb247XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dGVuc2lvbkluZm8pIHtcbiAgICAgIHRoaXMuX2V4dGVuc2lvbiA9IGV4dGVuc2lvbkZpeGVyKGV4dGVuc2lvbkluZm8uaWRlbnRpZmllcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5jb25uZWN0KCk7XG5cbiAgICAgIGlmIChyZXN1bHQ/LmFkZHJlc3MpIHtcbiAgICAgICAgY29uc3Qgd2FsbGV0QWRkcmVzczogc3RyaW5nID0gcmVzdWx0LmFkZHJlc3M7XG5cbiAgICAgICAgc3RvcmVTZXNzaW9uKHtcbiAgICAgICAgICBpZGVudGlmaWVyOiBleHRlbnNpb25JbmZvLmlkZW50aWZpZXIsXG4gICAgICAgICAgd2FsbGV0QWRkcmVzcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jaGVja1N0YXR1cygpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9O1xuXG4gIGRpc2Nvbm5lY3QgPSAoKSA9PiB7XG4gICAgY2xlYXJTZXNzaW9uKCk7XG5cbiAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgIHRoaXMuX3RlcnJhQWRkcmVzcy5uZXh0KG51bGwpO1xuICAgIHRoaXMuX2V4dGVuc2lvbiA9IG51bGw7XG4gIH07XG5cbiAgcmVjaGVja1N0YXR1cyA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5fZXh0ZW5zaW9uICYmICF0aGlzLl9leHRlbnNpb24uaW5UcmFuc2FjdGlvblByb2dyZXNzKCkpIHtcbiAgICAgIHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgICB9XG4gIH07XG5cbiAgcG9zdCA9IDxTZW5kRGF0YSBleHRlbmRzIHt9LCBQYXlsb2FkIGV4dGVuZHMge30+KFxuICAgIGRhdGE6IFNlbmREYXRhLFxuICApOiBQcm9taXNlPHsgbmFtZTogc3RyaW5nOyBwYXlsb2FkOiBQYXlsb2FkIH0+ID0+IHtcbiAgICBpZiAoIXRoaXMuX2V4dGVuc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBjb25uZWN0ZWQgd2FsbGV0YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9leHRlbnNpb24ucG9zdChkYXRhKTtcbiAgfTtcblxuICBzaWduID0gPFNlbmREYXRhIGV4dGVuZHMge30sIFBheWxvYWQgZXh0ZW5kcyB7fT4oXG4gICAgZGF0YTogU2VuZERhdGEsXG4gICk6IFByb21pc2U8eyBuYW1lOiBzdHJpbmc7IHBheWxvYWQ6IFBheWxvYWQgfT4gPT4ge1xuICAgIGlmICghdGhpcy5fZXh0ZW5zaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZXJlIGlzIG5vIGNvbm5lY3RlZCB3YWxsZXRgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2V4dGVuc2lvbi5zaWduKGRhdGEpO1xuICB9O1xufVxuIl19