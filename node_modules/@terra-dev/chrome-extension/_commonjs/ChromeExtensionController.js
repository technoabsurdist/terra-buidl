"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChromeExtensionController = void 0;
const browser_check_1 = require("@terra-dev/browser-check");
const terra_js_1 = require("@terra-money/terra.js");
const rxjs_1 = require("rxjs");
const defaultSelectModal_1 = require("./defaultSelectModal");
const extensionFixer_1 = require("./extensionFixer");
const multiChannel_1 = require("./multiChannel");
const storage_1 = require("./storage");
const types_1 = require("./types");
class ChromeExtensionController {
    constructor(options) {
        this.options = options;
        this._extension = null;
        this.status = () => {
            return this._status.asObservable();
        };
        this.networkInfo = () => {
            return this._networkInfo.asObservable();
        };
        this.terraAddress = () => {
            return this._terraAddress.asObservable();
        };
        this.checkStatus = async () => {
            // do not check if browser isn't a chrome
            if (!this.isDesktopChrome) {
                return;
            }
            if (this.extensionInfos.length === 0) {
                this._status.next(types_1.ChromeExtensionStatus.UNAVAILABLE);
                return;
            }
            if (!this._extension) {
                this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                return;
            }
            // get networkInfo from extension
            const infoPayload = await this._extension.info();
            if (infoPayload &&
                this._networkInfo.getValue().chainID !== infoPayload.chainID) {
                this._networkInfo.next(infoPayload);
            }
            if (this.options.enableWalletConnection) {
                //const storageStoredWalletAddress: string | null = getStoredAddress();
                const session = (0, storage_1.getStoredSession)();
                // if the storage has wallet address
                if (session && terra_js_1.AccAddress.validate(session.walletAddress)) {
                    this._status.next(types_1.ChromeExtensionStatus.WALLET_CONNECTED);
                    const connectResult = await this._extension.connect();
                    // if address of extension is not same with the address of localStorage
                    if (connectResult.address &&
                        terra_js_1.AccAddress.validate(connectResult.address)) {
                        (0, storage_1.storeSession)({
                            walletAddress: connectResult.address,
                            identifier: session.identifier,
                        });
                    }
                    if (!!connectResult.address) {
                        if (this._terraAddress.getValue() !== connectResult.address) {
                            this._terraAddress.next(connectResult.address);
                        }
                    }
                    else {
                        (0, storage_1.clearSession)();
                        this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    }
                }
                else {
                    if (session) {
                        (0, storage_1.clearSession)();
                    }
                    this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                    this._terraAddress.next(null);
                }
            }
            else {
                this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
                this._terraAddress.next(null);
            }
        };
        this.connect = async (identifier) => {
            var _a;
            const extensionInfos = (0, multiChannel_1.getTerraChromeExtensions)();
            if (extensionInfos.length === 0) {
                return false;
            }
            let extensionInfo;
            if (identifier) {
                extensionInfo = extensionInfos.find((item) => item.identifier === identifier);
            }
            else if (extensionInfos.length === 1) {
                extensionInfo = extensionInfos[0];
            }
            else {
                const select = (_a = this.options.selectExtension) !== null && _a !== void 0 ? _a : defaultSelectModal_1.defaultSelectModal;
                const selection = await select(extensionInfos);
                if (selection) {
                    extensionInfo = selection;
                }
            }
            if (extensionInfo) {
                this._extension = (0, extensionFixer_1.extensionFixer)(extensionInfo.identifier);
                const result = await this._extension.connect();
                if (result === null || result === void 0 ? void 0 : result.address) {
                    const walletAddress = result.address;
                    (0, storage_1.storeSession)({
                        identifier: extensionInfo.identifier,
                        walletAddress,
                    });
                    await this.checkStatus();
                    return true;
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        };
        this.disconnect = () => {
            (0, storage_1.clearSession)();
            this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
            this._terraAddress.next(null);
            this._extension = null;
        };
        this.recheckStatus = () => {
            if (this._extension && !this._extension.inTransactionProgress()) {
                this.checkStatus();
            }
        };
        this.post = (data) => {
            if (!this._extension) {
                throw new Error(`There is no connected wallet`);
            }
            return this._extension.post(data);
        };
        this.sign = (data) => {
            if (!this._extension) {
                throw new Error(`There is no connected wallet`);
            }
            return this._extension.sign(data);
        };
        this.isDesktopChrome =
            typeof window !== 'undefined' &&
                (0, browser_check_1.isDesktopChrome)(options.dangerously__chromeExtensionCompatibleBrowserCheck(navigator.userAgent));
        this._status = new rxjs_1.BehaviorSubject(this.isDesktopChrome
            ? types_1.ChromeExtensionStatus.INITIALIZING
            : types_1.ChromeExtensionStatus.UNAVAILABLE);
        this._networkInfo = new rxjs_1.BehaviorSubject(options.defaultNetwork);
        this.extensionInfos = (0, multiChannel_1.getTerraChromeExtensions)();
        if (!this.isDesktopChrome) {
            this._terraAddress = new rxjs_1.BehaviorSubject(null);
            return;
        }
        // ---------------------------------------------
        // initialize session
        // ---------------------------------------------
        if (this.extensionInfos.length === 0) {
            this._terraAddress = new rxjs_1.BehaviorSubject(null);
            this._status.next(types_1.ChromeExtensionStatus.UNAVAILABLE);
            return;
        }
        const session = (0, storage_1.getStoredSession)();
        if (!session ||
            !this.extensionInfos.some((item) => item.identifier === session.identifier)) {
            this._terraAddress = new rxjs_1.BehaviorSubject(null);
            this._status.next(types_1.ChromeExtensionStatus.WALLET_NOT_CONNECTED);
            return;
        }
        this._terraAddress = new rxjs_1.BehaviorSubject(session.walletAddress);
        this._extension = (0, extensionFixer_1.extensionFixer)(session.identifier);
        this.checkStatus();
    }
}
exports.ChromeExtensionController = ChromeExtensionController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9AdGVycmEtZGV2L2Nocm9tZS1leHRlbnNpb24vQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0REFBMkQ7QUFFM0Qsb0RBQW1EO0FBQ25ELCtCQUF1QztBQUN2Qyw2REFBMEQ7QUFDMUQscURBQWtFO0FBQ2xFLGlEQUErRTtBQUMvRSx1Q0FBeUU7QUFDekUsbUNBQWdEO0FBYWhELE1BQWEseUJBQXlCO0lBU3BDLFlBQXFCLE9BQXlDO1FBQXpDLFlBQU8sR0FBUCxPQUFPLENBQWtDO1FBTHRELGVBQVUsR0FBMEIsSUFBSSxDQUFDO1FBOERqRCxXQUFNLEdBQUcsR0FBRyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3JDLENBQUMsQ0FBQztRQUVGLGdCQUFXLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQyxDQUFDLENBQUM7UUFFRixpQkFBWSxHQUFHLEdBQUcsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0MsQ0FBQyxDQUFDO1FBRUYsZ0JBQVcsR0FBRyxLQUFLLElBQUksRUFBRTtZQUN2Qix5Q0FBeUM7WUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3pCLE9BQU87YUFDUjtZQUVELElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNwQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyw2QkFBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDckQsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7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a3RvcENocm9tZSB9IGZyb20gJ0B0ZXJyYS1kZXYvYnJvd3Nlci1jaGVjayc7XG5pbXBvcnQgeyBOZXR3b3JrSW5mbyB9IGZyb20gJ0B0ZXJyYS1kZXYvd2FsbGV0LXR5cGVzJztcbmltcG9ydCB7IEFjY0FkZHJlc3MgfSBmcm9tICdAdGVycmEtbW9uZXkvdGVycmEuanMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWZhdWx0U2VsZWN0TW9kYWwgfSBmcm9tICcuL2RlZmF1bHRTZWxlY3RNb2RhbCc7XG5pbXBvcnQgeyBleHRlbnNpb25GaXhlciwgRml4ZWRFeHRlbnNpb24gfSBmcm9tICcuL2V4dGVuc2lvbkZpeGVyJztcbmltcG9ydCB7IENocm9tZUV4dGVuc2lvbkluZm8sIGdldFRlcnJhQ2hyb21lRXh0ZW5zaW9ucyB9IGZyb20gJy4vbXVsdGlDaGFubmVsJztcbmltcG9ydCB7IGNsZWFyU2Vzc2lvbiwgZ2V0U3RvcmVkU2Vzc2lvbiwgc3RvcmVTZXNzaW9uIH0gZnJvbSAnLi9zdG9yYWdlJztcbmltcG9ydCB7IENocm9tZUV4dGVuc2lvblN0YXR1cyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENocm9tZUV4dGVuc2lvbkNvbnRyb2xsZXJPcHRpb25zIHtcbiAgZGVmYXVsdE5ldHdvcms6IE5ldHdvcmtJbmZvO1xuICBlbmFibGVXYWxsZXRDb25uZWN0aW9uOiBib29sZWFuO1xuICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjazogKFxuICAgIHVzZXJBZ2VudDogc3RyaW5nLFxuICApID0+IGJvb2xlYW47XG4gIHNlbGVjdEV4dGVuc2lvbj86IChcbiAgICBleHRlbnNpb25JbmZvczogQ2hyb21lRXh0ZW5zaW9uSW5mb1tdLFxuICApID0+IFByb21pc2U8Q2hyb21lRXh0ZW5zaW9uSW5mbyB8IG51bGw+O1xufVxuXG5leHBvcnQgY2xhc3MgQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlciB7XG4gIHJlYWRvbmx5IF9zdGF0dXM6IEJlaGF2aW9yU3ViamVjdDxDaHJvbWVFeHRlbnNpb25TdGF0dXM+O1xuICByZWFkb25seSBfbmV0d29ya0luZm86IEJlaGF2aW9yU3ViamVjdDxOZXR3b3JrSW5mbz47XG4gIHJlYWRvbmx5IF90ZXJyYUFkZHJlc3M6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPjtcbiAgcHJpdmF0ZSBfZXh0ZW5zaW9uOiBGaXhlZEV4dGVuc2lvbiB8IG51bGwgPSBudWxsO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZXh0ZW5zaW9uSW5mb3M6IENocm9tZUV4dGVuc2lvbkluZm9bXTtcbiAgcHJpdmF0ZSByZWFkb25seSBpc0Rlc2t0b3BDaHJvbWU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgb3B0aW9uczogQ2hyb21lRXh0ZW5zaW9uQ29udHJvbGxlck9wdGlvbnMpIHtcbiAgICB0aGlzLmlzRGVza3RvcENocm9tZSA9XG4gICAgICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgaXNEZXNrdG9wQ2hyb21lKFxuICAgICAgICBvcHRpb25zLmRhbmdlcm91c2x5X19jaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlckNoZWNrKFxuICAgICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnQsXG4gICAgICAgICksXG4gICAgICApO1xuXG4gICAgdGhpcy5fc3RhdHVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDaHJvbWVFeHRlbnNpb25TdGF0dXM+KFxuICAgICAgdGhpcy5pc0Rlc2t0b3BDaHJvbWVcbiAgICAgICAgPyBDaHJvbWVFeHRlbnNpb25TdGF0dXMuSU5JVElBTElaSU5HXG4gICAgICAgIDogQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLlVOQVZBSUxBQkxFLFxuICAgICk7XG5cbiAgICB0aGlzLl9uZXR3b3JrSW5mbyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmV0d29ya0luZm8+KFxuICAgICAgb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICApO1xuXG4gICAgdGhpcy5leHRlbnNpb25JbmZvcyA9IGdldFRlcnJhQ2hyb21lRXh0ZW5zaW9ucygpO1xuXG4gICAgaWYgKCF0aGlzLmlzRGVza3RvcENocm9tZSkge1xuICAgICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBpbml0aWFsaXplIHNlc3Npb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBpZiAodGhpcy5leHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3RlcnJhQWRkcmVzcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4obnVsbCk7XG4gICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuVU5BVkFJTEFCTEUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb24gPSBnZXRTdG9yZWRTZXNzaW9uKCk7XG5cbiAgICBpZiAoXG4gICAgICAhc2Vzc2lvbiB8fFxuICAgICAgIXRoaXMuZXh0ZW5zaW9uSW5mb3Muc29tZShcbiAgICAgICAgKGl0ZW0pID0+IGl0ZW0uaWRlbnRpZmllciA9PT0gc2Vzc2lvbi5pZGVudGlmaWVyLFxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fdGVycmFBZGRyZXNzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihcbiAgICAgIHNlc3Npb24ud2FsbGV0QWRkcmVzcyxcbiAgICApO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uID0gZXh0ZW5zaW9uRml4ZXIoc2Vzc2lvbi5pZGVudGlmaWVyKTtcblxuICAgIHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgfVxuXG4gIHN0YXR1cyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdHVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIG5ldHdvcmtJbmZvID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9uZXR3b3JrSW5mby5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICB0ZXJyYUFkZHJlc3MgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3RlcnJhQWRkcmVzcy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBjaGVja1N0YXR1cyA9IGFzeW5jICgpID0+IHtcbiAgICAvLyBkbyBub3QgY2hlY2sgaWYgYnJvd3NlciBpc24ndCBhIGNocm9tZVxuICAgIGlmICghdGhpcy5pc0Rlc2t0b3BDaHJvbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5leHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5VTkFWQUlMQUJMRSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLl9leHRlbnNpb24pIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZ2V0IG5ldHdvcmtJbmZvIGZyb20gZXh0ZW5zaW9uXG4gICAgY29uc3QgaW5mb1BheWxvYWQgPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uaW5mbygpO1xuXG4gICAgaWYgKFxuICAgICAgaW5mb1BheWxvYWQgJiZcbiAgICAgIHRoaXMuX25ldHdvcmtJbmZvLmdldFZhbHVlKCkuY2hhaW5JRCAhPT0gaW5mb1BheWxvYWQuY2hhaW5JRFxuICAgICkge1xuICAgICAgdGhpcy5fbmV0d29ya0luZm8ubmV4dChpbmZvUGF5bG9hZCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5lbmFibGVXYWxsZXRDb25uZWN0aW9uKSB7XG4gICAgICAvL2NvbnN0IHN0b3JhZ2VTdG9yZWRXYWxsZXRBZGRyZXNzOiBzdHJpbmcgfCBudWxsID0gZ2V0U3RvcmVkQWRkcmVzcygpO1xuICAgICAgY29uc3Qgc2Vzc2lvbiA9IGdldFN0b3JlZFNlc3Npb24oKTtcblxuICAgICAgLy8gaWYgdGhlIHN0b3JhZ2UgaGFzIHdhbGxldCBhZGRyZXNzXG4gICAgICBpZiAoc2Vzc2lvbiAmJiBBY2NBZGRyZXNzLnZhbGlkYXRlKHNlc3Npb24ud2FsbGV0QWRkcmVzcykpIHtcbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9DT05ORUNURUQpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3RSZXN1bHQgPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uY29ubmVjdCgpO1xuXG4gICAgICAgIC8vIGlmIGFkZHJlc3Mgb2YgZXh0ZW5zaW9uIGlzIG5vdCBzYW1lIHdpdGggdGhlIGFkZHJlc3Mgb2YgbG9jYWxTdG9yYWdlXG4gICAgICAgIGlmIChcbiAgICAgICAgICBjb25uZWN0UmVzdWx0LmFkZHJlc3MgJiZcbiAgICAgICAgICBBY2NBZGRyZXNzLnZhbGlkYXRlKGNvbm5lY3RSZXN1bHQuYWRkcmVzcylcbiAgICAgICAgKSB7XG4gICAgICAgICAgc3RvcmVTZXNzaW9uKHtcbiAgICAgICAgICAgIHdhbGxldEFkZHJlc3M6IGNvbm5lY3RSZXN1bHQuYWRkcmVzcyxcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IHNlc3Npb24uaWRlbnRpZmllcixcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIWNvbm5lY3RSZXN1bHQuYWRkcmVzcykge1xuICAgICAgICAgIGlmICh0aGlzLl90ZXJyYUFkZHJlc3MuZ2V0VmFsdWUoKSAhPT0gY29ubmVjdFJlc3VsdC5hZGRyZXNzKSB7XG4gICAgICAgICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChjb25uZWN0UmVzdWx0LmFkZHJlc3MpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjbGVhclNlc3Npb24oKTtcbiAgICAgICAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoc2Vzc2lvbikge1xuICAgICAgICAgIGNsZWFyU2Vzc2lvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoQ2hyb21lRXh0ZW5zaW9uU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVEKTtcbiAgICAgICAgdGhpcy5fdGVycmFBZGRyZXNzLm5leHQobnVsbCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N0YXR1cy5uZXh0KENocm9tZUV4dGVuc2lvblN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCk7XG4gICAgICB0aGlzLl90ZXJyYUFkZHJlc3MubmV4dChudWxsKTtcbiAgICB9XG4gIH07XG5cbiAgY29ubmVjdCA9IGFzeW5jIChpZGVudGlmaWVyPzogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZXh0ZW5zaW9uSW5mb3MgPSBnZXRUZXJyYUNocm9tZUV4dGVuc2lvbnMoKTtcblxuICAgIGlmIChleHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgZXh0ZW5zaW9uSW5mbzogQ2hyb21lRXh0ZW5zaW9uSW5mbyB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChpZGVudGlmaWVyKSB7XG4gICAgICBleHRlbnNpb25JbmZvID0gZXh0ZW5zaW9uSW5mb3MuZmluZChcbiAgICAgICAgKGl0ZW0pID0+IGl0ZW0uaWRlbnRpZmllciA9PT0gaWRlbnRpZmllcixcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChleHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDEpIHtcbiAgICAgIGV4dGVuc2lvbkluZm8gPSBleHRlbnNpb25JbmZvc1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc2VsZWN0ID0gdGhpcy5vcHRpb25zLnNlbGVjdEV4dGVuc2lvbiA/PyBkZWZhdWx0U2VsZWN0TW9kYWw7XG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSBhd2FpdCBzZWxlY3QoZXh0ZW5zaW9uSW5mb3MpO1xuXG4gICAgICBpZiAoc2VsZWN0aW9uKSB7XG4gICAgICAgIGV4dGVuc2lvbkluZm8gPSBzZWxlY3Rpb247XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dGVuc2lvbkluZm8pIHtcbiAgICAgIHRoaXMuX2V4dGVuc2lvbiA9IGV4dGVuc2lvbkZpeGVyKGV4dGVuc2lvbkluZm8uaWRlbnRpZmllcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5jb25uZWN0KCk7XG5cbiAgICAgIGlmIChyZXN1bHQ/LmFkZHJlc3MpIHtcbiAgICAgICAgY29uc3Qgd2FsbGV0QWRkcmVzczogc3RyaW5nID0gcmVzdWx0LmFkZHJlc3M7XG5cbiAgICAgICAgc3RvcmVTZXNzaW9uKHtcbiAgICAgICAgICBpZGVudGlmaWVyOiBleHRlbnNpb25JbmZvLmlkZW50aWZpZXIsXG4gICAgICAgICAgd2FsbGV0QWRkcmVzcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jaGVja1N0YXR1cygpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9O1xuXG4gIGRpc2Nvbm5lY3QgPSAoKSA9PiB7XG4gICAgY2xlYXJTZXNzaW9uKCk7XG5cbiAgICB0aGlzLl9zdGF0dXMubmV4dChDaHJvbWVFeHRlbnNpb25TdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQpO1xuICAgIHRoaXMuX3RlcnJhQWRkcmVzcy5uZXh0KG51bGwpO1xuICAgIHRoaXMuX2V4dGVuc2lvbiA9IG51bGw7XG4gIH07XG5cbiAgcmVjaGVja1N0YXR1cyA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5fZXh0ZW5zaW9uICYmICF0aGlzLl9leHRlbnNpb24uaW5UcmFuc2FjdGlvblByb2dyZXNzKCkpIHtcbiAgICAgIHRoaXMuY2hlY2tTdGF0dXMoKTtcbiAgICB9XG4gIH07XG5cbiAgcG9zdCA9IDxTZW5kRGF0YSBleHRlbmRzIHt9LCBQYXlsb2FkIGV4dGVuZHMge30+KFxuICAgIGRhdGE6IFNlbmREYXRhLFxuICApOiBQcm9taXNlPHsgbmFtZTogc3RyaW5nOyBwYXlsb2FkOiBQYXlsb2FkIH0+ID0+IHtcbiAgICBpZiAoIXRoaXMuX2V4dGVuc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBjb25uZWN0ZWQgd2FsbGV0YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9leHRlbnNpb24ucG9zdChkYXRhKTtcbiAgfTtcblxuICBzaWduID0gPFNlbmREYXRhIGV4dGVuZHMge30sIFBheWxvYWQgZXh0ZW5kcyB7fT4oXG4gICAgZGF0YTogU2VuZERhdGEsXG4gICk6IFByb21pc2U8eyBuYW1lOiBzdHJpbmc7IHBheWxvYWQ6IFBheWxvYWQgfT4gPT4ge1xuICAgIGlmICghdGhpcy5fZXh0ZW5zaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZXJlIGlzIG5vIGNvbm5lY3RlZCB3YWxsZXRgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2V4dGVuc2lvbi5zaWduKGRhdGEpO1xuICB9O1xufVxuIl19