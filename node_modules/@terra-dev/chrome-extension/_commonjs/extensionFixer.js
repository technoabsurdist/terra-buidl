"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.extensionFixer = void 0;
const wallet_types_1 = require("@terra-dev/wallet-types");
const errors_1 = require("./errors");
const terra_js_1 = require("@terra-money/terra.js");
function toExplicitError(error) {
    if (error && 'code' in error) {
        switch (error.code) {
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L182
            case 1:
                return new wallet_types_1.UserDenied();
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L137
            case 2:
                if (error.data) {
                    const { txhash } = error.data;
                    return new errors_1.ChromeExtensionTxFailed(txhash, error.message);
                }
                else {
                    return new errors_1.ChromeExtensionTxFailed(undefined, error.message);
                }
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L153
            case 3:
                return new errors_1.ChromeExtensionCreateTxFailed(error.message);
            default:
                return new errors_1.ChromeExtensionUnspecifiedError(error.message);
        }
    }
    else {
        return new errors_1.ChromeExtensionUnspecifiedError();
    }
}
const pool = new Map();
function extensionFixer(identifier) {
    if (pool.has(identifier)) {
        return pool.get(identifier);
    }
    const extension = new terra_js_1.Extension(identifier);
    let _inTransactionProgress = false;
    const postResolvers = new Map();
    const signResolvers = new Map();
    const infoResolvers = new Set();
    const connectResolvers = new Set();
    extension.on('onPost', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!postResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = postResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onPost', payload });
        }
        postResolvers.delete(payload.id);
        if (postResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onSign', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!signResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = signResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onSign', payload });
        }
        signResolvers.delete(payload.id);
        if (signResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onInfo', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of infoResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        infoResolvers.clear();
    });
    extension.on('onConnect', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of connectResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        connectResolvers.clear();
    });
    function post(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.post({
                ...data,
                purgeQueue: true,
            });
            postResolvers.set(id, resolver);
            setTimeout(() => {
                if (postResolvers.has(id)) {
                    postResolvers.delete(id);
                    if (postResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function sign(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.sign({
                ...data,
                purgeQueue: true,
            });
            signResolvers.set(id, resolver);
            setTimeout(() => {
                if (signResolvers.has(id)) {
                    signResolvers.delete(id);
                    if (signResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function connect() {
        return new Promise((...resolver) => {
            connectResolvers.add(resolver);
            extension.connect();
        });
    }
    function info() {
        return new Promise((...resolver) => {
            infoResolvers.add(resolver);
            extension.info();
        });
    }
    //function isAvailable() {
    //  return extension.isAvailable;
    //}
    function inTransactionProgress() {
        return _inTransactionProgress;
    }
    const result = {
        post,
        sign,
        connect,
        info,
        //isAvailable,
        inTransactionProgress,
    };
    pool.set(identifier, result);
    return result;
}
exports.extensionFixer = extensionFixer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uRml4ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvQHRlcnJhLWRldi9jaHJvbWUtZXh0ZW5zaW9uL2V4dGVuc2lvbkZpeGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDBEQUFrRTtBQUNsRSxxQ0FJa0I7QUFDbEIsb0RBQWtEO0FBaUJsRCxTQUFTLGVBQWUsQ0FBQyxLQUFVO0lBQ2pDLElBQUksS0FBSyxJQUFJLE1BQU0sSUFBSSxLQUFLLEVBQUU7UUFDNUIsUUFBUSxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ2xCLHlGQUF5RjtZQUN6RixLQUFLLENBQUM7Z0JBQ0osT0FBTyxJQUFJLHlCQUFVLEVBQUUsQ0FBQztZQUMxQix5RkFBeUY7WUFDekYsS0FBSyxDQUFDO2dCQUNKLElBQUksS0FBSyxDQUFDLElBQUksRUFBRTtvQkFDZCxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztvQkFDOUIsT0FBTyxJQUFJLGdDQUF1QixDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQzNEO3FCQUFNO29CQUNMLE9BQU8sSUFBSSxnQ0FBdUIsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUM5RDtZQUNILHlGQUF5RjtZQUN6RixLQUFLLENBQUM7Z0JBQ0osT0FBTyxJQUFJLHNDQUE2QixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMxRDtnQkFDRSxPQUFPLElBQUksd0NBQStCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzdEO0tBQ0Y7U0FBTTtRQUNMLE9BQU8sSUFBSSx3Q0FBK0IsRUFBRSxDQUFDO0tBQzlDO0FBQ0gsQ0FBQztBQUVELE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxFQUEwQixDQUFDO0FBRS9DLFNBQWdCLGNBQWMsQ0FBQyxVQUFrQjtJQUMvQyxJQUFJLElB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USxDQUFDLENBQUM7WUFDNUIsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELDBCQUEwQjtJQUMxQixpQ0FBaUM7SUFDakMsR0FBRztJQUVILFNBQVMscUJBQXFCO1FBQzVCLE9BQU8sc0JBQXNCLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFtQjtRQUM3QixJQUFJO1FBQ0osSUFBSTtRQUNKLE9BQU87UUFDUCxJQUFJO1FBQ0osY0FBYztRQUNkLHFCQUFxQjtLQUN0QixDQUFDO0lBRUYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFN0IsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQXZMRCx3Q0F1TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZXR3b3JrSW5mbywgVXNlckRlbmllZCB9IGZyb20gJ0B0ZXJyYS1kZXYvd2FsbGV0LXR5cGVzJztcbmltcG9ydCB7XG4gIENocm9tZUV4dGVuc2lvbkNyZWF0ZVR4RmFpbGVkLFxuICBDaHJvbWVFeHRlbnNpb25UeEZhaWxlZCxcbiAgQ2hyb21lRXh0ZW5zaW9uVW5zcGVjaWZpZWRFcnJvcixcbn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgRXh0ZW5zaW9uIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3RlcnJhLmpzJztcblxudHlwZSBDb25uZWN0UmVzcG9uc2UgPSB7IGFkZHJlc3M/OiBzdHJpbmcgfTtcbnR5cGUgUG9zdFJlc3BvbnNlID0gYW55O1xudHlwZSBTaWduUmVzcG9uc2UgPSBhbnk7XG50eXBlIEluZm9SZXNwb25zZSA9IE5ldHdvcmtJbmZvO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpeGVkRXh0ZW5zaW9uIHtcbiAgLy8vKiogQGRlcHJlY2F0ZWQgZG8gbm90IHVzZSBleHRlbnNpb24uaXNBdmFpbGFibGUganVzdCB1c2Ugd2luZG93LmlzVGVycmFFeHRlbnNpb25BdmFpbGFibGUuLi4gKi9cbiAgLy9pc0F2YWlsYWJsZTogKCkgPT4gYm9vbGVhbjtcbiAgcG9zdDogKGRhdGE6IG9iamVjdCkgPT4gUHJvbWlzZTxQb3N0UmVzcG9uc2U+O1xuICBzaWduOiAoZGF0YTogb2JqZWN0KSA9PiBQcm9taXNlPFNpZ25SZXNwb25zZT47XG4gIGluZm86ICgpID0+IFByb21pc2U8SW5mb1Jlc3BvbnNlPjtcbiAgY29ubmVjdDogKCkgPT4gUHJvbWlzZTxDb25uZWN0UmVzcG9uc2U+O1xuICBpblRyYW5zYWN0aW9uUHJvZ3Jlc3M6ICgpID0+IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIHRvRXhwbGljaXRFcnJvcihlcnJvcjogYW55KSB7XG4gIGlmIChlcnJvciAmJiAnY29kZScgaW4gZXJyb3IpIHtcbiAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHtcbiAgICAgIC8vIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3RlcnJhLXByb2plY3Qvc3RhdGlvbi9ibG9iL21haW4vc3JjL2V4dGVuc2lvbi9Db25maXJtLnRzeCNMMTgyXG4gICAgICBjYXNlIDE6XG4gICAgICAgIHJldHVybiBuZXcgVXNlckRlbmllZCgpO1xuICAgICAgLy8gQHNlZSBodHRwczovL2dpdGh1Yi5jb20vdGVycmEtcHJvamVjdC9zdGF0aW9uL2Jsb2IvbWFpbi9zcmMvZXh0ZW5zaW9uL0NvbmZpcm0udHN4I0wxMzdcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgaWYgKGVycm9yLmRhdGEpIHtcbiAgICAgICAgICBjb25zdCB7IHR4aGFzaCB9ID0gZXJyb3IuZGF0YTtcbiAgICAgICAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvblR4RmFpbGVkKHR4aGFzaCwgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25UeEZhaWxlZCh1bmRlZmluZWQsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICAvLyBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS90ZXJyYS1wcm9qZWN0L3N0YXRpb24vYmxvYi9tYWluL3NyYy9leHRlbnNpb24vQ29uZmlybS50c3gjTDE1M1xuICAgICAgY2FzZSAzOlxuICAgICAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvbkNyZWF0ZVR4RmFpbGVkKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25VbnNwZWNpZmllZEVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV3IENocm9tZUV4dGVuc2lvblVuc3BlY2lmaWVkRXJyb3IoKTtcbiAgfVxufVxuXG5jb25zdCBwb29sID0gbmV3IE1hcDxzdHJpbmcsIEZpeGVkRXh0ZW5zaW9uPigpO1xuXG5leHBvcnQgZnVuY3Rpb24gZXh0ZW5zaW9uRml4ZXIoaWRlbnRpZmllcjogc3RyaW5nKTogRml4ZWRFeHRlbnNpb24ge1xuICBpZiAocG9vbC5oYXMoaWRlbnRpZmllcikpIHtcbiAgICByZXR1cm4gcG9vbC5nZXQoaWRlbnRpZmllcikhO1xuICB9XG5cbiAgY29uc3QgZXh0ZW5zaW9uID0gbmV3IEV4dGVuc2lvbihpZGVudGlmaWVyKTtcblxuICBsZXQgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IGZhbHNlO1xuXG4gIGNvbnN0IHBvc3RSZXNvbHZlcnMgPSBuZXcgTWFwPFxuICAgIG51bWJlcixcbiAgICBbKGRhdGE6IGFueSkgPT4gdm9pZCwgKGVycm9yOiBhbnkpID0+IHZvaWRdXG4gID4oKTtcblxuICBjb25zdCBzaWduUmVzb2x2ZXJzID0gbmV3IE1hcDxcbiAgICBudW1iZXIsXG4gICAgWyhkYXRhOiBhbnkpID0+IHZvaWQsIChlcnJvcjogYW55KSA9PiB2b2lkXVxuICA+KCk7XG5cbiAgY29uc3QgaW5mb1Jlc29sdmVycyA9IG5ldyBTZXQ8WyhkYXRhOiBhbnkpID0+IHZvaWQsIChlcnJvcjogYW55KSA9PiB2b2lkXT4oKTtcblxuICBjb25zdCBjb25uZWN0UmVzb2x2ZXJzID0gbmV3IFNldDxcbiAgICBbKGRhdGE6IGFueSkgPT4gdm9pZCwgKGVycm9yOiBhbnkpID0+IHZvaWRdXG4gID4oKTtcblxuICBleHRlbnNpb24ub24oJ29uUG9zdCcsIChyZXN1bHQpID0+IHtcbiAgICBpZiAoIXJlc3VsdCkgcmV0dXJuO1xuXG4gICAgY29uc3QgeyBlcnJvciwgLi4ucGF5bG9hZCB9ID0gcmVzdWx0O1xuXG4gICAgaWYgKCFwb3N0UmVzb2x2ZXJzLmhhcyhwYXlsb2FkLmlkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IFtyZXNvbHZlLCByZWplY3RdID0gcG9zdFJlc29sdmVycy5nZXQocGF5bG9hZC5pZCkhO1xuXG4gICAgaWYgKCFwYXlsb2FkLnN1Y2Nlc3MpIHtcbiAgICAgIHJlamVjdCh0b0V4cGxpY2l0RXJyb3IoZXJyb3IpKTtcbiAgICB9IGVsc2UgaWYgKHJlc29sdmUpIHtcbiAgICAgIHJlc29sdmUoeyBuYW1lOiAnb25Qb3N0JywgcGF5bG9hZCB9KTtcbiAgICB9XG5cbiAgICBwb3N0UmVzb2x2ZXJzLmRlbGV0ZShwYXlsb2FkLmlkKTtcblxuICAgIGlmIChwb3N0UmVzb2x2ZXJzLnNpemUgPT09IDApIHtcbiAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICB9XG4gIH0pO1xuXG4gIGV4dGVuc2lvbi5vbignb25TaWduJywgKHJlc3VsdCkgPT4ge1xuICAgIGlmICghcmVzdWx0KSByZXR1cm47XG5cbiAgICBjb25zdCB7IGVycm9yLCAuLi5wYXlsb2FkIH0gPSByZXN1bHQ7XG5cbiAgICBpZiAoIXNpZ25SZXNvbHZlcnMuaGFzKHBheWxvYWQuaWQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgW3Jlc29sdmUsIHJlamVjdF0gPSBzaWduUmVzb2x2ZXJzLmdldChwYXlsb2FkLmlkKSE7XG5cbiAgICBpZiAoIXBheWxvYWQuc3VjY2Vzcykge1xuICAgICAgcmVqZWN0KHRvRXhwbGljaXRFcnJvcihlcnJvcikpO1xuICAgIH0gZWxzZSBpZiAocmVzb2x2ZSkge1xuICAgICAgcmVzb2x2ZSh7IG5hbWU6ICdvblNpZ24nLCBwYXlsb2FkIH0pO1xuICAgIH1cblxuICAgIHNpZ25SZXNvbHZlcnMuZGVsZXRlKHBheWxvYWQuaWQpO1xuXG4gICAgaWYgKHNpZ25SZXNvbHZlcnMuc2l6ZSA9PT0gMCkge1xuICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IGZhbHNlO1xuICAgIH1cbiAgfSk7XG5cbiAgZXh0ZW5zaW9uLm9uKCdvbkluZm8nLCAocmVzdWx0KSA9PiB7XG4gICAgaWYgKCFyZXN1bHQpIHJldHVybjtcbiAgICBjb25zdCB7IGVycm9yLCAuLi5wYXlsb2FkIH0gPSByZXN1bHQ7XG5cbiAgICBmb3IgKGNvbnN0IFtyZXNvbHZlLCByZWplY3RdIG9mIGluZm9SZXNvbHZlcnMpIHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZShwYXlsb2FkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpbmZvUmVzb2x2ZXJzLmNsZWFyKCk7XG4gIH0pO1xuXG4gIGV4dGVuc2lvbi5vbignb25Db25uZWN0JywgKHJlc3VsdCkgPT4ge1xuICAgIGlmICghcmVzdWx0KSByZXR1cm47XG4gICAgY29uc3QgeyBlcnJvciwgLi4ucGF5bG9hZCB9ID0gcmVzdWx0O1xuXG4gICAgZm9yIChjb25zdCBbcmVzb2x2ZSwgcmVqZWN0XSBvZiBjb25uZWN0UmVzb2x2ZXJzKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUocGF5bG9hZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29ubmVjdFJlc29sdmVycy5jbGVhcigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBwb3N0KGRhdGE6IG9iamVjdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxQb3N0UmVzcG9uc2U+KCguLi5yZXNvbHZlcikgPT4ge1xuICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IHRydWU7XG5cbiAgICAgIGNvbnN0IGlkID0gZXh0ZW5zaW9uLnBvc3Qoe1xuICAgICAgICAuLi4oZGF0YSBhcyBhbnkpLFxuICAgICAgICBwdXJnZVF1ZXVlOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIHBvc3RSZXNvbHZlcnMuc2V0KGlkLCByZXNvbHZlcik7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBpZiAocG9zdFJlc29sdmVycy5oYXMoaWQpKSB7XG4gICAgICAgICAgcG9zdFJlc29sdmVycy5kZWxldGUoaWQpO1xuXG4gICAgICAgICAgaWYgKHBvc3RSZXNvbHZlcnMuc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSwgMTAwMCAqIDEyMCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBzaWduKGRhdGE6IG9iamVjdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTaWduUmVzcG9uc2U+KCguLi5yZXNvbHZlcikgPT4ge1xuICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IHRydWU7XG5cbiAgICAgIGNvbnN0IGlkID0gZXh0ZW5zaW9uLnNpZ24oe1xuICAgICAgICAuLi4oZGF0YSBhcyBhbnkpLFxuICAgICAgICBwdXJnZVF1ZXVlOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIHNpZ25SZXNvbHZlcnMuc2V0KGlkLCByZXNvbHZlcik7XG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBpZiAoc2lnblJlc29sdmVycy5oYXMoaWQpKSB7XG4gICAgICAgICAgc2lnblJlc29sdmVycy5kZWxldGUoaWQpO1xuXG4gICAgICAgICAgaWYgKHNpZ25SZXNvbHZlcnMuc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgX2luVHJhbnNhY3Rpb25Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSwgMTAwMCAqIDEyMCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBjb25uZWN0KCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxDb25uZWN0UmVzcG9uc2U+KCguLi5yZXNvbHZlcikgPT4ge1xuICAgICAgY29ubmVjdFJlc29sdmVycy5hZGQocmVzb2x2ZXIpO1xuICAgICAgZXh0ZW5zaW9uLmNvbm5lY3QoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGluZm8oKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEluZm9SZXNwb25zZT4oKC4uLnJlc29sdmVyKSA9PiB7XG4gICAgICBpbmZvUmVzb2x2ZXJzLmFkZChyZXNvbHZlcik7XG4gICAgICBleHRlbnNpb24uaW5mbygpO1xuICAgIH0pO1xuICB9XG5cbiAgLy9mdW5jdGlvbiBpc0F2YWlsYWJsZSgpIHtcbiAgLy8gIHJldHVybiBleHRlbnNpb24uaXNBdmFpbGFibGU7XG4gIC8vfVxuXG4gIGZ1bmN0aW9uIGluVHJhbnNhY3Rpb25Qcm9ncmVzcygpIHtcbiAgICByZXR1cm4gX2luVHJhbnNhY3Rpb25Qcm9ncmVzcztcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdDogRml4ZWRFeHRlbnNpb24gPSB7XG4gICAgcG9zdCxcbiAgICBzaWduLFxuICAgIGNvbm5lY3QsXG4gICAgaW5mbyxcbiAgICAvL2lzQXZhaWxhYmxlLFxuICAgIGluVHJhbnNhY3Rpb25Qcm9ncmVzcyxcbiAgfTtcblxuICBwb29sLnNldChpZGVudGlmaWVyLCByZXN1bHQpO1xuXG4gIHJldHVybiByZXN1bHQ7XG59XG4iXX0=