import { UserDenied } from '@terra-dev/wallet-types';
import { ChromeExtensionCreateTxFailed, ChromeExtensionTxFailed, ChromeExtensionUnspecifiedError, } from './errors';
import { Extension } from '@terra-money/terra.js';
function toExplicitError(error) {
    if (error && 'code' in error) {
        switch (error.code) {
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L182
            case 1:
                return new UserDenied();
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L137
            case 2:
                if (error.data) {
                    const { txhash } = error.data;
                    return new ChromeExtensionTxFailed(txhash, error.message);
                }
                else {
                    return new ChromeExtensionTxFailed(undefined, error.message);
                }
            // @see https://github.com/terra-project/station/blob/main/src/extension/Confirm.tsx#L153
            case 3:
                return new ChromeExtensionCreateTxFailed(error.message);
            default:
                return new ChromeExtensionUnspecifiedError(error.message);
        }
    }
    else {
        return new ChromeExtensionUnspecifiedError();
    }
}
const pool = new Map();
export function extensionFixer(identifier) {
    if (pool.has(identifier)) {
        return pool.get(identifier);
    }
    const extension = new Extension(identifier);
    let _inTransactionProgress = false;
    const postResolvers = new Map();
    const signResolvers = new Map();
    const infoResolvers = new Set();
    const connectResolvers = new Set();
    extension.on('onPost', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!postResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = postResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onPost', payload });
        }
        postResolvers.delete(payload.id);
        if (postResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onSign', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        if (!signResolvers.has(payload.id)) {
            return;
        }
        const [resolve, reject] = signResolvers.get(payload.id);
        if (!payload.success) {
            reject(toExplicitError(error));
        }
        else if (resolve) {
            resolve({ name: 'onSign', payload });
        }
        signResolvers.delete(payload.id);
        if (signResolvers.size === 0) {
            _inTransactionProgress = false;
        }
    });
    extension.on('onInfo', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of infoResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        infoResolvers.clear();
    });
    extension.on('onConnect', (result) => {
        if (!result)
            return;
        const { error, ...payload } = result;
        for (const [resolve, reject] of connectResolvers) {
            if (error) {
                reject(error);
            }
            else {
                resolve(payload);
            }
        }
        connectResolvers.clear();
    });
    function post(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.post({
                ...data,
                purgeQueue: true,
            });
            postResolvers.set(id, resolver);
            setTimeout(() => {
                if (postResolvers.has(id)) {
                    postResolvers.delete(id);
                    if (postResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function sign(data) {
        return new Promise((...resolver) => {
            _inTransactionProgress = true;
            const id = extension.sign({
                ...data,
                purgeQueue: true,
            });
            signResolvers.set(id, resolver);
            setTimeout(() => {
                if (signResolvers.has(id)) {
                    signResolvers.delete(id);
                    if (signResolvers.size === 0) {
                        _inTransactionProgress = false;
                    }
                }
            }, 1000 * 120);
        });
    }
    function connect() {
        return new Promise((...resolver) => {
            connectResolvers.add(resolver);
            extension.connect();
        });
    }
    function info() {
        return new Promise((...resolver) => {
            infoResolvers.add(resolver);
            extension.info();
        });
    }
    //function isAvailable() {
    //  return extension.isAvailable;
    //}
    function inTransactionProgress() {
        return _inTransactionProgress;
    }
    const result = {
        post,
        sign,
        connect,
        info,
        //isAvailable,
        inTransactionProgress,
    };
    pool.set(identifier, result);
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uRml4ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQHRlcnJhLWRldi9jaHJvbWUtZXh0ZW5zaW9uL2V4dGVuc2lvbkZpeGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBZSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNsRSxPQUFPLEVBQ0wsNkJBQTZCLEVBQzdCLHVCQUF1QixFQUN2QiwrQkFBK0IsR0FDaEMsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBaUJsRCxTQUFTLGVBQWUsQ0FBQyxLQUFVO0lBQ2pDLElBQUksS0FBSyxJQUFJLE1BQU0sSUFBSSxLQUFLLEVBQUU7UUFDNUIsUUFBUSxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ2xCLHlGQUF5RjtZQUN6RixLQUFLLENBQUM7Z0JBQ0osT0FBTyxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQzFCLHlGQUF5RjtZQUN6RixLQUFLLENBQUM7Z0JBQ0osSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO29CQUNkLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO29CQUM5QixPQUFPLElBQUksdUJBQXVCLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDM0Q7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLHVCQUF1QixDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQzlEO1lBQ0gseUZBQXlGO1lBQ3pGLEtBQUssQ0FBQztnQkFDSixPQUFPLElBQUksNkJBQTZCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzFEO2dCQUNFLE9BQU8sSUFBSSwrQkFBK0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDN0Q7S0FDRjtTQUFNO1FBQ0wsT0FBTyxJQUFJLCtCQUEr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QUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsU0FBUyxJQUFJO1FBQ1gsT0FBTyxJQUFJLE9BQU8sQ0FBZSxDQUFDLEdBQUcsUUFBUSxFQUFFLEVBQUU7WUFDL0MsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1QixTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsMEJBQTBCO0lBQzFCLGlDQUFpQztJQUNqQyxHQUFHO0lBRUgsU0FBUyxxQkFBcUI7UUFDNUIsT0FBTyxzQkFBc0IsQ0FBQztJQUNoQyxDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQW1CO1FBQzdCLElBQUk7UUFDSixJQUFJO1FBQ0osT0FBTztRQUNQLElBQUk7UUFDSixjQUFjO1FBQ2QscUJBQXFCO0tBQ3RCLENBQUM7SUFFRixJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUU3QixPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV0d29ya0luZm8sIFVzZXJEZW5pZWQgfSBmcm9tICdAdGVycmEtZGV2L3dhbGxldC10eXBlcyc7XG5pbXBvcnQge1xuICBDaHJvbWVFeHRlbnNpb25DcmVhdGVUeEZhaWxlZCxcbiAgQ2hyb21lRXh0ZW5zaW9uVHhGYWlsZWQsXG4gIENocm9tZUV4dGVuc2lvblVuc3BlY2lmaWVkRXJyb3IsXG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCB7IEV4dGVuc2lvbiB9IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5cbnR5cGUgQ29ubmVjdFJlc3BvbnNlID0geyBhZGRyZXNzPzogc3RyaW5nIH07XG50eXBlIFBvc3RSZXNwb25zZSA9IGFueTtcbnR5cGUgU2lnblJlc3BvbnNlID0gYW55O1xudHlwZSBJbmZvUmVzcG9uc2UgPSBOZXR3b3JrSW5mbztcblxuZXhwb3J0IGludGVyZmFjZSBGaXhlZEV4dGVuc2lvbiB7XG4gIC8vLyoqIEBkZXByZWNhdGVkIGRvIG5vdCB1c2UgZXh0ZW5zaW9uLmlzQXZhaWxhYmxlIGp1c3QgdXNlIHdpbmRvdy5pc1RlcnJhRXh0ZW5zaW9uQXZhaWxhYmxlLi4uICovXG4gIC8vaXNBdmFpbGFibGU6ICgpID0+IGJvb2xlYW47XG4gIHBvc3Q6IChkYXRhOiBvYmplY3QpID0+IFByb21pc2U8UG9zdFJlc3BvbnNlPjtcbiAgc2lnbjogKGRhdGE6IG9iamVjdCkgPT4gUHJvbWlzZTxTaWduUmVzcG9uc2U+O1xuICBpbmZvOiAoKSA9PiBQcm9taXNlPEluZm9SZXNwb25zZT47XG4gIGNvbm5lY3Q6ICgpID0+IFByb21pc2U8Q29ubmVjdFJlc3BvbnNlPjtcbiAgaW5UcmFuc2FjdGlvblByb2dyZXNzOiAoKSA9PiBib29sZWFuO1xufVxuXG5mdW5jdGlvbiB0b0V4cGxpY2l0RXJyb3IoZXJyb3I6IGFueSkge1xuICBpZiAoZXJyb3IgJiYgJ2NvZGUnIGluIGVycm9yKSB7XG4gICAgc3dpdGNoIChlcnJvci5jb2RlKSB7XG4gICAgICAvLyBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS90ZXJyYS1wcm9qZWN0L3N0YXRpb24vYmxvYi9tYWluL3NyYy9leHRlbnNpb24vQ29uZmlybS50c3gjTDE4MlxuICAgICAgY2FzZSAxOlxuICAgICAgICByZXR1cm4gbmV3IFVzZXJEZW5pZWQoKTtcbiAgICAgIC8vIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3RlcnJhLXByb2plY3Qvc3RhdGlvbi9ibG9iL21haW4vc3JjL2V4dGVuc2lvbi9Db25maXJtLnRzeCNMMTM3XG4gICAgICBjYXNlIDI6XG4gICAgICAgIGlmIChlcnJvci5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgeyB0eGhhc2ggfSA9IGVycm9yLmRhdGE7XG4gICAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25UeEZhaWxlZCh0eGhhc2gsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBuZXcgQ2hyb21lRXh0ZW5zaW9uVHhGYWlsZWQodW5kZWZpbmVkLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgLy8gQHNlZSBodHRwczovL2dpdGh1Yi5jb20vdGVycmEtcHJvamVjdC9zdGF0aW9uL2Jsb2IvbWFpbi9zcmMvZXh0ZW5zaW9uL0NvbmZpcm0udHN4I0wxNTNcbiAgICAgIGNhc2UgMzpcbiAgICAgICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25DcmVhdGVUeEZhaWxlZChlcnJvci5tZXNzYWdlKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBuZXcgQ2hyb21lRXh0ZW5zaW9uVW5zcGVjaWZpZWRFcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBDaHJvbWVFeHRlbnNpb25VbnNwZWNpZmllZEVycm9yKCk7XG4gIH1cbn1cblxuY29uc3QgcG9vbCA9IG5ldyBNYXA8c3RyaW5nLCBGaXhlZEV4dGVuc2lvbj4oKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGV4dGVuc2lvbkZpeGVyKGlkZW50aWZpZXI6IHN0cmluZyk6IEZpeGVkRXh0ZW5zaW9uIHtcbiAgaWYgKHBvb2wuaGFzKGlkZW50aWZpZXIpKSB7XG4gICAgcmV0dXJuIHBvb2wuZ2V0KGlkZW50aWZpZXIpITtcbiAgfVxuXG4gIGNvbnN0IGV4dGVuc2lvbiA9IG5ldyBFeHRlbnNpb24oaWRlbnRpZmllcik7XG5cbiAgbGV0IF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcblxuICBjb25zdCBwb3N0UmVzb2x2ZXJzID0gbmV3IE1hcDxcbiAgICBudW1iZXIsXG4gICAgWyhkYXRhOiBhbnkpID0+IHZvaWQsIChlcnJvcjogYW55KSA9PiB2b2lkXVxuICA+KCk7XG5cbiAgY29uc3Qgc2lnblJlc29sdmVycyA9IG5ldyBNYXA8XG4gICAgbnVtYmVyLFxuICAgIFsoZGF0YTogYW55KSA9PiB2b2lkLCAoZXJyb3I6IGFueSkgPT4gdm9pZF1cbiAgPigpO1xuXG4gIGNvbnN0IGluZm9SZXNvbHZlcnMgPSBuZXcgU2V0PFsoZGF0YTogYW55KSA9PiB2b2lkLCAoZXJyb3I6IGFueSkgPT4gdm9pZF0+KCk7XG5cbiAgY29uc3QgY29ubmVjdFJlc29sdmVycyA9IG5ldyBTZXQ8XG4gICAgWyhkYXRhOiBhbnkpID0+IHZvaWQsIChlcnJvcjogYW55KSA9PiB2b2lkXVxuICA+KCk7XG5cbiAgZXh0ZW5zaW9uLm9uKCdvblBvc3QnLCAocmVzdWx0KSA9PiB7XG4gICAgaWYgKCFyZXN1bHQpIHJldHVybjtcblxuICAgIGNvbnN0IHsgZXJyb3IsIC4uLnBheWxvYWQgfSA9IHJlc3VsdDtcblxuICAgIGlmICghcG9zdFJlc29sdmVycy5oYXMocGF5bG9hZC5pZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBbcmVzb2x2ZSwgcmVqZWN0XSA9IHBvc3RSZXNvbHZlcnMuZ2V0KHBheWxvYWQuaWQpITtcblxuICAgIGlmICghcGF5bG9hZC5zdWNjZXNzKSB7XG4gICAgICByZWplY3QodG9FeHBsaWNpdEVycm9yKGVycm9yKSk7XG4gICAgfSBlbHNlIGlmIChyZXNvbHZlKSB7XG4gICAgICByZXNvbHZlKHsgbmFtZTogJ29uUG9zdCcsIHBheWxvYWQgfSk7XG4gICAgfVxuXG4gICAgcG9zdFJlc29sdmVycy5kZWxldGUocGF5bG9hZC5pZCk7XG5cbiAgICBpZiAocG9zdFJlc29sdmVycy5zaXplID09PSAwKSB7XG4gICAgICBfaW5UcmFuc2FjdGlvblByb2dyZXNzID0gZmFsc2U7XG4gICAgfVxuICB9KTtcblxuICBleHRlbnNpb24ub24oJ29uU2lnbicsIChyZXN1bHQpID0+IHtcbiAgICBpZiAoIXJlc3VsdCkgcmV0dXJuO1xuXG4gICAgY29uc3QgeyBlcnJvciwgLi4ucGF5bG9hZCB9ID0gcmVzdWx0O1xuXG4gICAgaWYgKCFzaWduUmVzb2x2ZXJzLmhhcyhwYXlsb2FkLmlkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IFtyZXNvbHZlLCByZWplY3RdID0gc2lnblJlc29sdmVycy5nZXQocGF5bG9hZC5pZCkhO1xuXG4gICAgaWYgKCFwYXlsb2FkLnN1Y2Nlc3MpIHtcbiAgICAgIHJlamVjdCh0b0V4cGxpY2l0RXJyb3IoZXJyb3IpKTtcbiAgICB9IGVsc2UgaWYgKHJlc29sdmUpIHtcbiAgICAgIHJlc29sdmUoeyBuYW1lOiAnb25TaWduJywgcGF5bG9hZCB9KTtcbiAgICB9XG5cbiAgICBzaWduUmVzb2x2ZXJzLmRlbGV0ZShwYXlsb2FkLmlkKTtcblxuICAgIGlmIChzaWduUmVzb2x2ZXJzLnNpemUgPT09IDApIHtcbiAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICB9XG4gIH0pO1xuXG4gIGV4dGVuc2lvbi5vbignb25JbmZvJywgKHJlc3VsdCkgPT4ge1xuICAgIGlmICghcmVzdWx0KSByZXR1cm47XG4gICAgY29uc3QgeyBlcnJvciwgLi4ucGF5bG9hZCB9ID0gcmVzdWx0O1xuXG4gICAgZm9yIChjb25zdCBbcmVzb2x2ZSwgcmVqZWN0XSBvZiBpbmZvUmVzb2x2ZXJzKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUocGF5bG9hZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaW5mb1Jlc29sdmVycy5jbGVhcigpO1xuICB9KTtcblxuICBleHRlbnNpb24ub24oJ29uQ29ubmVjdCcsIChyZXN1bHQpID0+IHtcbiAgICBpZiAoIXJlc3VsdCkgcmV0dXJuO1xuICAgIGNvbnN0IHsgZXJyb3IsIC4uLnBheWxvYWQgfSA9IHJlc3VsdDtcblxuICAgIGZvciAoY29uc3QgW3Jlc29sdmUsIHJlamVjdF0gb2YgY29ubmVjdFJlc29sdmVycykge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKHBheWxvYWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbm5lY3RSZXNvbHZlcnMuY2xlYXIoKTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gcG9zdChkYXRhOiBvYmplY3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8UG9zdFJlc3BvbnNlPigoLi4ucmVzb2x2ZXIpID0+IHtcbiAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSB0cnVlO1xuXG4gICAgICBjb25zdCBpZCA9IGV4dGVuc2lvbi5wb3N0KHtcbiAgICAgICAgLi4uKGRhdGEgYXMgYW55KSxcbiAgICAgICAgcHVyZ2VRdWV1ZTogdHJ1ZSxcbiAgICAgIH0pO1xuXG4gICAgICBwb3N0UmVzb2x2ZXJzLnNldChpZCwgcmVzb2x2ZXIpO1xuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaWYgKHBvc3RSZXNvbHZlcnMuaGFzKGlkKSkge1xuICAgICAgICAgIHBvc3RSZXNvbHZlcnMuZGVsZXRlKGlkKTtcblxuICAgICAgICAgIGlmIChwb3N0UmVzb2x2ZXJzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sIDEwMDAgKiAxMjApO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gc2lnbihkYXRhOiBvYmplY3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8U2lnblJlc3BvbnNlPigoLi4ucmVzb2x2ZXIpID0+IHtcbiAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSB0cnVlO1xuXG4gICAgICBjb25zdCBpZCA9IGV4dGVuc2lvbi5zaWduKHtcbiAgICAgICAgLi4uKGRhdGEgYXMgYW55KSxcbiAgICAgICAgcHVyZ2VRdWV1ZTogdHJ1ZSxcbiAgICAgIH0pO1xuXG4gICAgICBzaWduUmVzb2x2ZXJzLnNldChpZCwgcmVzb2x2ZXIpO1xuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaWYgKHNpZ25SZXNvbHZlcnMuaGFzKGlkKSkge1xuICAgICAgICAgIHNpZ25SZXNvbHZlcnMuZGVsZXRlKGlkKTtcblxuICAgICAgICAgIGlmIChzaWduUmVzb2x2ZXJzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sIDEwMDAgKiAxMjApO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gY29ubmVjdCgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8Q29ubmVjdFJlc3BvbnNlPigoLi4ucmVzb2x2ZXIpID0+IHtcbiAgICAgIGNvbm5lY3RSZXNvbHZlcnMuYWRkKHJlc29sdmVyKTtcbiAgICAgIGV4dGVuc2lvbi5jb25uZWN0KCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBpbmZvKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxJbmZvUmVzcG9uc2U+KCguLi5yZXNvbHZlcikgPT4ge1xuICAgICAgaW5mb1Jlc29sdmVycy5hZGQocmVzb2x2ZXIpO1xuICAgICAgZXh0ZW5zaW9uLmluZm8oKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vZnVuY3Rpb24gaXNBdmFpbGFibGUoKSB7XG4gIC8vICByZXR1cm4gZXh0ZW5zaW9uLmlzQXZhaWxhYmxlO1xuICAvL31cblxuICBmdW5jdGlvbiBpblRyYW5zYWN0aW9uUHJvZ3Jlc3MoKSB7XG4gICAgcmV0dXJuIF9pblRyYW5zYWN0aW9uUHJvZ3Jlc3M7XG4gIH1cblxuICBjb25zdCByZXN1bHQ6IEZpeGVkRXh0ZW5zaW9uID0ge1xuICAgIHBvc3QsXG4gICAgc2lnbixcbiAgICBjb25uZWN0LFxuICAgIGluZm8sXG4gICAgLy9pc0F2YWlsYWJsZSxcbiAgICBpblRyYW5zYWN0aW9uUHJvZ3Jlc3MsXG4gIH07XG5cbiAgcG9vbC5zZXQoaWRlbnRpZmllciwgcmVzdWx0KTtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuIl19