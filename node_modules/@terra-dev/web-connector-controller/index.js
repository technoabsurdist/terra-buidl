import { WebConnectorStatusType, } from '@terra-dev/web-connector-interface';
import bowser from 'bowser';
import { BehaviorSubject } from 'rxjs';
async function getConnector(hostWindow) {
    return new Promise((resolve) => {
        let count = 20;
        function task() {
            if (--count > 0) {
                if (typeof hostWindow.terraWebConnectors !== 'undefined' &&
                    Array.isArray(hostWindow.terraWebConnectors) &&
                    hostWindow.terraWebConnectors.length > 0) {
                    console.log(`TerraWebConnector: `, JSON.stringify(hostWindow.terraWebConnectors[0].getInfo()));
                    resolve(hostWindow.terraWebConnectors[0]);
                }
                else {
                    console.warn(`Can't find window.terraWebConnectors. wait 500ms...`);
                    setTimeout(task, 500);
                }
            }
            else {
                resolve(undefined);
            }
        }
        task();
    });
}
export class WebConnectorController {
    constructor(hostWindow) {
        this.hostWindow = hostWindow;
        this._connector = null;
        /**
         * Refetch the clientsStates
         *
         * You don't need call this method in most cases.
         * Normally, when the clientStates is changed, states() get the new clientStates.
         *
         * @example
         * client.states()
         *       .subscribe(states => {
         *         // 2. will get new clientStates
         *         console.log('Got new states', Date.now())
         *       })
         *
         * function callback() {
         *   // 1. refetch client states
         *   client.refetchStates()
         * }
         */
        this.refetchStates = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.refetchStates();
        };
        /**
         * Request approval connection to the Extension. (Connect)
         */
        this.requestApproval = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.requestApproval();
        };
        this.status = () => {
            return this._status.asObservable();
        };
        this.getLastStatus = () => {
            return this._status.getValue();
        };
        /**
         * Execute transaction
         *
         * @example
         * client.post(terraAddress, tx: CreateTxOptions)
         *       .subscribe({
         *          next: (result: WebConnectorTxProgress | WebConnectorTxSucceed) => {
         *            switch (result.status) {
         *              case WebConnectorTxStatus.PROGRESS:
         *                console.log('in progress', result.payload)
         *                break;
         *              case WebConnectorTxStatus.SUCCEED:
         *                console.log('succeed', result.payload)
         *                break;
         *            }
         *          },
         *          error: (error) => {
         *            if (error instanceof WebConnectorUserDenied) {
         *              console.log('user denied')
         *            } else if (error instanceof WebConnectorCreateTxFailed) {
         *              console.log('create tx failed', error.message)
         *            } else if (error instanceof WebConnectorTxFailed) {
         *              console.log('tx failed', error.txhash, error.message, error.raw_message)
         *            } else {
         *              console.log('unspecified error', 'message' in error ? error.message : String(error))
         *            }
         *          }
         *       })
         *
         * @description The stream will be
         * TxProgress -> [...TxProgress] -> TxSucceed
         *
         * - Tx is Succeed : TxProgress -> [...TxProgress] -> TxSucceed
         */
        this.post = (terraAddress, tx) => {
            return this._connector.post(terraAddress, tx);
        };
        this.hasCW20Tokens = (chainID, ...tokenAddrs) => {
            return this._connector.hasCW20Tokens(chainID, ...tokenAddrs);
        };
        /**
         * Add CW20 Token to extension dashboard
         */
        this.addCW20Tokens = (chainID, ...tokenAddrs) => {
            return this._connector.addCW20Tokens(chainID, ...tokenAddrs);
        };
        this.hasNetwork = (chainID, lcd) => {
            return this._connector.hasNetwork({
                chainID,
                lcd,
            });
        };
        this.addNetwork = (name, chainID, lcd) => {
            return this._connector.addNetwork({
                name: name !== null && name !== void 0 ? name : '',
                chainID,
                lcd,
            });
        };
        /**
         * @example
         * client.states()
         *       .subscribe(states => {
         *         if (!states) {
         *           console.log('client is still not ready')
         *         } else {
         *           console.log('current network is', states.network)
         *           console.log('current wallets are', states.wallets)
         *         }
         *       })
         */
        this.states = () => {
            return this._states.asObservable();
        };
        this.getLastStates = () => {
            return this._states.getValue();
        };
        /**
         * Destroy this client
         *
         * - Unsubscribe all RxJs Subjects (every Observables are stoped)
         */
        this.destroy = () => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.close();
            this._connector = null;
        };
        this._status = new BehaviorSubject({
            type: WebConnectorStatusType.INITIALIZING,
        });
        this._states = new BehaviorSubject(null);
        const browser = bowser.getParser(navigator.userAgent);
        //@ts-ignore
        getConnector(hostWindow).then((connector) => {
            if (!connector) {
                const name = browser.getBrowserName(true);
                let installLink;
                switch (name) {
                    case 'chrome':
                    case 'microsoft edge':
                        installLink = 'https://google.com/chrome';
                        break;
                    case 'firefox':
                        installLink = 'https://google.com/firefox';
                        break;
                    case 'safari':
                        installLink = 'https://google.com/safari';
                        break;
                    default:
                        installLink = 'https://google.com/chrome';
                        break;
                }
                this._status.next({
                    type: WebConnectorStatusType.NO_AVAILABLE,
                    isConnectorExists: false,
                    installLink,
                });
                return;
            }
            if (!connector.checkBrowserAvailability(navigator.userAgent)) {
                this._status.next({
                    type: WebConnectorStatusType.NO_AVAILABLE,
                    isConnectorExists: true,
                    isSupportBrowser: false,
                });
                return;
            }
            connector.open(hostWindow, this._status, this._states);
            this._connector = connector;
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvQHRlcnJhLWRldi93ZWItY29ubmVjdG9yLWNvbnRyb2xsZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUlMLHNCQUFzQixHQUV2QixNQUFNLG9DQUFvQyxDQUFDO0FBRTVDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBRW5ELEtBQUssVUFBVSxZQUFZLENBQUMsVUFFM0I7SUFDQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7UUFDN0IsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWYsU0FBUyxJQUFJO1lBQ1gsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUU7Z0JBQ2YsSUFDRSxPQUFPLFVBQVUsQ0FBQyxrQkFBa0IsS0FBSyxXQUFXO29CQUNwRCxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQztvQkFDNUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQ3hDO29CQUNBLE9BQU8sQ0FBQyxHQUFHLENBQ1QscUJBQXFCLEVBQ3JCLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQzNELENBQUM7b0JBQ0YsT0FBTyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUMzQztxQkFBTTtvQkFDTCxPQUFPLENBQUMsSUFBSSxDQUFDLHFEQUFxRCxDQUFDLENBQUM7b0JBQ3BFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0Y7aUJBQU07Z0JBQ0wsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ3BCO1FBQ0gsQ0FB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Q0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFdkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBdUlGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgVGVycmFXZWJDb25uZWN0b3IsXG4gIFdlYkNvbm5lY3RvclN0YXRlcyxcbiAgV2ViQ29ubmVjdG9yU3RhdHVzLFxuICBXZWJDb25uZWN0b3JTdGF0dXNUeXBlLFxuICBXZWJDb25uZWN0b3JUeFJlc3VsdCxcbn0gZnJvbSAnQHRlcnJhLWRldi93ZWItY29ubmVjdG9yLWludGVyZmFjZSc7XG5pbXBvcnQgeyBDcmVhdGVUeE9wdGlvbnMgfSBmcm9tICdAdGVycmEtbW9uZXkvdGVycmEuanMnO1xuaW1wb3J0IGJvd3NlciBmcm9tICdib3dzZXInO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldENvbm5lY3Rvcihob3N0V2luZG93OiB7XG4gIHRlcnJhV2ViQ29ubmVjdG9yczogVGVycmFXZWJDb25uZWN0b3JbXSB8IHVuZGVmaW5lZDtcbn0pOiBQcm9taXNlPFRlcnJhV2ViQ29ubmVjdG9yIHwgdW5kZWZpbmVkPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGxldCBjb3VudCA9IDIwO1xuXG4gICAgZnVuY3Rpb24gdGFzaygpIHtcbiAgICAgIGlmICgtLWNvdW50ID4gMCkge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdHlwZW9mIGhvc3RXaW5kb3cudGVycmFXZWJDb25uZWN0b3JzICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgICAgIEFycmF5LmlzQXJyYXkoaG9zdFdpbmRvdy50ZXJyYVdlYkNvbm5lY3RvcnMpICYmXG4gICAgICAgICAgaG9zdFdpbmRvdy50ZXJyYVdlYkNvbm5lY3RvcnMubGVuZ3RoID4gMFxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgIGBUZXJyYVdlYkNvbm5lY3RvcjogYCxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGhvc3RXaW5kb3cudGVycmFXZWJDb25uZWN0b3JzWzBdLmdldEluZm8oKSksXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXNvbHZlKGhvc3RXaW5kb3cudGVycmFXZWJDb25uZWN0b3JzWzBdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oYENhbid0IGZpbmQgd2luZG93LnRlcnJhV2ViQ29ubmVjdG9ycy4gd2FpdCA1MDBtcy4uLmApO1xuICAgICAgICAgIHNldFRpbWVvdXQodGFzaywgNTAwKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRhc2soKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBjbGFzcyBXZWJDb25uZWN0b3JDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdHVzOiBCZWhhdmlvclN1YmplY3Q8V2ViQ29ubmVjdG9yU3RhdHVzPjtcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdGVzOiBCZWhhdmlvclN1YmplY3Q8V2ViQ29ubmVjdG9yU3RhdGVzIHwgbnVsbD47XG4gIHByaXZhdGUgX2Nvbm5lY3RvcjogVGVycmFXZWJDb25uZWN0b3IgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGhvc3RXaW5kb3c6IFdpbmRvdykge1xuICAgIHRoaXMuX3N0YXR1cyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8V2ViQ29ubmVjdG9yU3RhdHVzPih7XG4gICAgICB0eXBlOiBXZWJDb25uZWN0b3JTdGF0dXNUeXBlLklOSVRJQUxJWklORyxcbiAgICB9KTtcblxuICAgIHRoaXMuX3N0YXRlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8V2ViQ29ubmVjdG9yU3RhdGVzIHwgbnVsbD4obnVsbCk7XG5cbiAgICBjb25zdCBicm93c2VyID0gYm93c2VyLmdldFBhcnNlcihuYXZpZ2F0b3IudXNlckFnZW50KTtcblxuICAgIC8vQHRzLWlnbm9yZVxuICAgIGdldENvbm5lY3Rvcihob3N0V2luZG93KS50aGVuKChjb25uZWN0b3IpID0+IHtcbiAgICAgIGlmICghY29ubmVjdG9yKSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBicm93c2VyLmdldEJyb3dzZXJOYW1lKHRydWUpO1xuXG4gICAgICAgIGxldCBpbnN0YWxsTGluazogc3RyaW5nO1xuXG4gICAgICAgIHN3aXRjaCAobmFtZSkge1xuICAgICAgICAgIGNhc2UgJ2Nocm9tZSc6XG4gICAgICAgICAgY2FzZSAnbWljcm9zb2Z0IGVkZ2UnOlxuICAgICAgICAgICAgaW5zdGFsbExpbmsgPSAnaHR0cHM6Ly9nb29nbGUuY29tL2Nocm9tZSc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdmaXJlZm94JzpcbiAgICAgICAgICAgIGluc3RhbGxMaW5rID0gJ2h0dHBzOi8vZ29vZ2xlLmNvbS9maXJlZm94JztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ3NhZmFyaSc6XG4gICAgICAgICAgICBpbnN0YWxsTGluayA9ICdodHRwczovL2dvb2dsZS5jb20vc2FmYXJpJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBpbnN0YWxsTGluayA9ICdodHRwczovL2dvb2dsZS5jb20vY2hyb21lJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoe1xuICAgICAgICAgIHR5cGU6IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuTk9fQVZBSUxBQkxFLFxuICAgICAgICAgIGlzQ29ubmVjdG9yRXhpc3RzOiBmYWxzZSxcbiAgICAgICAgICBpbnN0YWxsTGluayxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNvbm5lY3Rvci5jaGVja0Jyb3dzZXJBdmFpbGFiaWxpdHkobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHtcbiAgICAgICAgdGhpcy5fc3RhdHVzLm5leHQoe1xuICAgICAgICAgIHR5cGU6IFdlYkNvbm5lY3RvclN0YXR1c1R5cGUuTk9fQVZBSUxBQkxFLFxuICAgICAgICAgIGlzQ29ubmVjdG9yRXhpc3RzOiB0cnVlLFxuICAgICAgICAgIGlzU3VwcG9ydEJyb3dzZXI6IGZhbHNlLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbm5lY3Rvci5vcGVuKGhvc3RXaW5kb3csIHRoaXMuX3N0YXR1cywgdGhpcy5fc3RhdGVzKTtcblxuICAgICAgdGhpcy5fY29ubmVjdG9yID0gY29ubmVjdG9yO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZmV0Y2ggdGhlIGNsaWVudHNTdGF0ZXNcbiAgICpcbiAgICogWW91IGRvbid0IG5lZWQgY2FsbCB0aGlzIG1ldGhvZCBpbiBtb3N0IGNhc2VzLlxuICAgKiBOb3JtYWxseSwgd2hlbiB0aGUgY2xpZW50U3RhdGVzIGlzIGNoYW5nZWQsIHN0YXRlcygpIGdldCB0aGUgbmV3IGNsaWVudFN0YXRlcy5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogY2xpZW50LnN0YXRlcygpXG4gICAqICAgICAgIC5zdWJzY3JpYmUoc3RhdGVzID0+IHtcbiAgICogICAgICAgICAvLyAyLiB3aWxsIGdldCBuZXcgY2xpZW50U3RhdGVzXG4gICAqICAgICAgICAgY29uc29sZS5sb2coJ0dvdCBuZXcgc3RhdGVzJywgRGF0ZS5ub3coKSlcbiAgICogICAgICAgfSlcbiAgICpcbiAgICogZnVuY3Rpb24gY2FsbGJhY2soKSB7XG4gICAqICAgLy8gMS4gcmVmZXRjaCBjbGllbnQgc3RhdGVzXG4gICAqICAgY2xpZW50LnJlZmV0Y2hTdGF0ZXMoKVxuICAgKiB9XG4gICAqL1xuICByZWZldGNoU3RhdGVzID0gKCkgPT4ge1xuICAgIHRoaXMuX2Nvbm5lY3Rvcj8ucmVmZXRjaFN0YXRlcygpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IGFwcHJvdmFsIGNvbm5lY3Rpb24gdG8gdGhlIEV4dGVuc2lvbi4gKENvbm5lY3QpXG4gICAqL1xuICByZXF1ZXN0QXBwcm92YWwgPSAoKSA9PiB7XG4gICAgdGhpcy5fY29ubmVjdG9yPy5yZXF1ZXN0QXBwcm92YWwoKTtcbiAgfTtcblxuICBzdGF0dXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXR1cy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBnZXRMYXN0U3RhdHVzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0dXMuZ2V0VmFsdWUoKTtcbiAgfTtcblxuICAvKipcbiAgICogRXhlY3V0ZSB0cmFuc2FjdGlvblxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBjbGllbnQucG9zdCh0ZXJyYUFkZHJlc3MsIHR4OiBDcmVhdGVUeE9wdGlvbnMpXG4gICAqICAgICAgIC5zdWJzY3JpYmUoe1xuICAgKiAgICAgICAgICBuZXh0OiAocmVzdWx0OiBXZWJDb25uZWN0b3JUeFByb2dyZXNzIHwgV2ViQ29ubmVjdG9yVHhTdWNjZWVkKSA9PiB7XG4gICAqICAgICAgICAgICAgc3dpdGNoIChyZXN1bHQuc3RhdHVzKSB7XG4gICAqICAgICAgICAgICAgICBjYXNlIFdlYkNvbm5lY3RvclR4U3RhdHVzLlBST0dSRVNTOlxuICAgKiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnaW4gcHJvZ3Jlc3MnLCByZXN1bHQucGF5bG9hZClcbiAgICogICAgICAgICAgICAgICAgYnJlYWs7XG4gICAqICAgICAgICAgICAgICBjYXNlIFdlYkNvbm5lY3RvclR4U3RhdHVzLlNVQ0NFRUQ6XG4gICAqICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWNjZWVkJywgcmVzdWx0LnBheWxvYWQpXG4gICAqICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgKiAgICAgICAgICAgIH1cbiAgICogICAgICAgICAgfSxcbiAgICogICAgICAgICAgZXJyb3I6IChlcnJvcikgPT4ge1xuICAgKiAgICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFdlYkNvbm5lY3RvclVzZXJEZW5pZWQpIHtcbiAgICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd1c2VyIGRlbmllZCcpXG4gICAqICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIFdlYkNvbm5lY3RvckNyZWF0ZVR4RmFpbGVkKSB7XG4gICAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY3JlYXRlIHR4IGZhaWxlZCcsIGVycm9yLm1lc3NhZ2UpXG4gICAqICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIFdlYkNvbm5lY3RvclR4RmFpbGVkKSB7XG4gICAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygndHggZmFpbGVkJywgZXJyb3IudHhoYXNoLCBlcnJvci5tZXNzYWdlLCBlcnJvci5yYXdfbWVzc2FnZSlcbiAgICogICAgICAgICAgICB9IGVsc2Uge1xuICAgKiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3Vuc3BlY2lmaWVkIGVycm9yJywgJ21lc3NhZ2UnIGluIGVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcikpXG4gICAqICAgICAgICAgICAgfVxuICAgKiAgICAgICAgICB9XG4gICAqICAgICAgIH0pXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvbiBUaGUgc3RyZWFtIHdpbGwgYmVcbiAgICogVHhQcm9ncmVzcyAtPiBbLi4uVHhQcm9ncmVzc10gLT4gVHhTdWNjZWVkXG4gICAqXG4gICAqIC0gVHggaXMgU3VjY2VlZCA6IFR4UHJvZ3Jlc3MgLT4gWy4uLlR4UHJvZ3Jlc3NdIC0+IFR4U3VjY2VlZFxuICAgKi9cbiAgcG9zdCA9IChcbiAgICB0ZXJyYUFkZHJlc3M6IHN0cmluZyxcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICApOiBPYnNlcnZhYmxlPFdlYkNvbm5lY3RvclR4UmVzdWx0PiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3RvciEucG9zdCh0ZXJyYUFkZHJlc3MsIHR4KTtcbiAgfTtcblxuICBoYXNDVzIwVG9rZW5zID0gKGNoYWluSUQ6IHN0cmluZywgLi4udG9rZW5BZGRyczogc3RyaW5nW10pID0+IHtcbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yIS5oYXNDVzIwVG9rZW5zKGNoYWluSUQsIC4uLnRva2VuQWRkcnMpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGQgQ1cyMCBUb2tlbiB0byBleHRlbnNpb24gZGFzaGJvYXJkXG4gICAqL1xuICBhZGRDVzIwVG9rZW5zID0gKGNoYWluSUQ6IHN0cmluZywgLi4udG9rZW5BZGRyczogc3RyaW5nW10pID0+IHtcbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yIS5hZGRDVzIwVG9rZW5zKGNoYWluSUQsIC4uLnRva2VuQWRkcnMpO1xuICB9O1xuXG4gIGhhc05ldHdvcmsgPSAoY2hhaW5JRDogc3RyaW5nLCBsY2Q6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3IhLmhhc05ldHdvcmsoe1xuICAgICAgY2hhaW5JRCxcbiAgICAgIGxjZCxcbiAgICB9KTtcbiAgfTtcblxuICBhZGROZXR3b3JrID0gKG5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCwgY2hhaW5JRDogc3RyaW5nLCBsY2Q6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3IhLmFkZE5ldHdvcmsoe1xuICAgICAgbmFtZTogbmFtZSA/PyAnJyxcbiAgICAgIGNoYWluSUQsXG4gICAgICBsY2QsXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBleGFtcGxlXG4gICAqIGNsaWVudC5zdGF0ZXMoKVxuICAgKiAgICAgICAuc3Vic2NyaWJlKHN0YXRlcyA9PiB7XG4gICAqICAgICAgICAgaWYgKCFzdGF0ZXMpIHtcbiAgICogICAgICAgICAgIGNvbnNvbGUubG9nKCdjbGllbnQgaXMgc3RpbGwgbm90IHJlYWR5JylcbiAgICogICAgICAgICB9IGVsc2Uge1xuICAgKiAgICAgICAgICAgY29uc29sZS5sb2coJ2N1cnJlbnQgbmV0d29yayBpcycsIHN0YXRlcy5uZXR3b3JrKVxuICAgKiAgICAgICAgICAgY29uc29sZS5sb2coJ2N1cnJlbnQgd2FsbGV0cyBhcmUnLCBzdGF0ZXMud2FsbGV0cylcbiAgICogICAgICAgICB9XG4gICAqICAgICAgIH0pXG4gICAqL1xuICBzdGF0ZXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlcy5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBnZXRMYXN0U3RhdGVzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZXMuZ2V0VmFsdWUoKTtcbiAgfTtcblxuICAvKipcbiAgICogRGVzdHJveSB0aGlzIGNsaWVudFxuICAgKlxuICAgKiAtIFVuc3Vic2NyaWJlIGFsbCBSeEpzIFN1YmplY3RzIChldmVyeSBPYnNlcnZhYmxlcyBhcmUgc3RvcGVkKVxuICAgKi9cbiAgZGVzdHJveSA9ICgpID0+IHtcbiAgICB0aGlzLl9jb25uZWN0b3I/LmNsb3NlKCk7XG4gICAgdGhpcy5fY29ubmVjdG9yID0gbnVsbDtcbiAgfTtcbn1cbiJdfQ==